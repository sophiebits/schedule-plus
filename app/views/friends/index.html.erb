<%= javascript_include_tag "friends_sort.js" %>
<div id="page-content" class="friends">
  <div id="content-header">
    <div class="container">
      <h1 id="header">Friends (<%= @friends.length %>)</h1>
    </div>
  </div>
<script>
(function ($) {
  // custom css expression for a case-insensitive contains()
  jQuery.expr[':'].Contains = function(a,i,m){
      return (a.textContent || a.innerText || "").toUpperCase().indexOf(m[3].toUpperCase())>=0;
  };


  function listFilter(header, list, list1) { // header is any element, list is an unordered list
    // create and add the filter form to the header
    var form = $("<form>").attr({"class":"filterform","action":"#","id":"friends-search-form"}),
        input = $("<input>").attr({"class":"filterinput","type":"text", "placeholder":"Search For Friends"});
    $(form).append(input).appendTo(header);

    $(input)
      .change( function () {
        var filter = $(this).val();
        if(filter) {
          // this finds all links in a list that contain the input,
          // and hide the ones not containing the input while showing the ones that do
          $(list).find("a:not(:Contains(" + filter + "))").parent().hide();
          $(list).find("a:Contains(" + filter + ")").parent().show();
          $(list1).find("a:not(:Contains(" + filter + "))").parent().hide();
          $(list1).find("a:Contains(" + filter + ")").parent().show();

        } else {
          $(list).find("li").show();
          $(list1).find("li").show();
        }
        return false;
      })
    .keyup( function () {
        // fire the above change event after every letter
        $(this).change();
    });
  }


  //ondomready
  $(function () {
    listFilter($("#content-header .container"), $("#old_list"), $("#curr_list"));
  });
}(jQuery));
  </script>

<div class="container">
  <button id="sort-name">name</button>
  <button id="sort-mutual">mutual courses</button>
  <button id="sort-free">free/not free</button>
  <h3 class="friends-list-header"><%= current_semester.name %> friends</h3>
  <ul id="curr_list", class="friends-list">
<% curr_friends = @friends.select {|f| !f.main_schedule(current_semester).nil? } %>
<% prev_friends = @friends.reject {|f| !f.main_schedule(current_semester).nil? } %>

<% curr_friends.each do |friend| %>
    <li>
      <a href="<%= user_path(friend) %>" class="friend-link">
        <img class="friend-pic"
             alt="<%= friend.name %>"
             src="http://graph.facebook.com/<%= friend.uid %>/picture" />
        <span class="friend-name"><%= friend.name %></span>
        <span class="friend-mutual-courses"><% 
        # mutual courses = intersection of two sets
        if current_user.main_schedule && friend.main_schedule then
          mutuals = friend.courses & current_user.courses
        else
          mutuals = []
        end
        # TODO on hover show actual courses
         %><%= mutuals.length %> mutual courses</span>
        <span class="friend-status"><%= friend.status %></span>
      </a>
    </li><% 
end 
%>
  </ul>
  <h3 class="friends-list-header">Other friends on schedule+</h3>
  <ul id = "old_list", class="friends-list"><% 
prev_friends.each do |friend| %>
    <li>
      <a href="<%= user_path(friend) %>" class="friend-link">
        <img class="friend-pic"
             alt="<%= friend.name %>"
             src="http://graph.facebook.com/<%= friend.uid %>/picture" />
        <span class="friend-name"><%= friend.name %></span>
        <span class="last-seen">Last seen: <%=
        begin
          friend.schedules.primary.map(&:semester).last.name
        rescue
          "Never"
        end
        %></span>
      </a>
    </li><% 
end %> 
  </ul>
  </div>
</div>
  
<!-- BEGIN Old Friends Page -->
  <script type="text/javascript">/*
  $(document).ready(function() {
		$('.common-courses .tooltip').hide();
		$('.common-courses .tooltip > ul > li').textOverflow();
		
		$('#friends-container').delegate('.count','hover',function(e) {
      if (e.type === 'mouseenter')
        $(this).prev('.tooltip').show();
      else
		    $(this).prev('.tooltip').hide();
		});
	});*/
  </script>  <!--
  <form id="search-friends"><input type="text" placeholder="Search Friends" id="search-input"></input><img id="search-friends-cancel" src="/images/friends-search-cancel.png" /></form>
	<div id="friends">
		<div id="sort-friends">
			<span id="sort-name">name</span>
			<span id="sort-free">free/in class</span>
			<span id="sort-cic">courses in common</span>
		</div>
	  <ul id="friends-container"></ul>
	  <span class="nav-previous">previous page</span>
	  <span class="nav-next">next page</span>
  </div>
<END Old Friends Page -->
