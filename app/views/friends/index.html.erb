<% content_for :content do %>
<div class="main-aside">
  <!--
  <ul id="friends-sort-options">
    <li>Sort by Name</li>
    <li>Sort by Courses in Common</li>
  </ul>
  -->
  <span class="tooltip" id="share-prompt">
    Share schedule+ with your friends on facebook to see more schedules!
  </span>
  <a href="#" class="fb-share">Share</a>
  <script type="text/javascript">

	$(document).ready(function() {

    $('.fb-share').click(function(e) {
      e.preventDefault();
      FB.ui({ method:'feed',
        name:'schedule+',
        link:'http://scheduleplus.org/',
        picture:'http://scheduleplus.org/images/schedule-plus-logo-square.jpg',
        description:'schedule+ connects you to your Carnegie Mellon friends on Facebook by matching your planned course schedules. See which courses are most common among your friends, or find out which of your friends is free for a lunchtime get-together.',
        message:"I'm now using schedule+ to share my CMU schedule with friends. Check it out!"
      });
      return false;
    });

		$('.common-courses .tooltip').hide();
		$('.common-courses .tooltip > ul > li').textOverflow();
		
		$('#friends-container').delegate('.count','hover',function(e) {
      if (e.type === 'mouseenter')
        $(this).prev('.tooltip').show();
      else
		    $(this).prev('.tooltip').hide();
		});
	});
  </script>
</div>
<div id="article">
  <h1 class="friends">Friends</h1>
  <form id="search-friends"><input type="text" placeholder="Search Friends" id="search-input"></input><img id="search-friends-cancel" src="/images/friends-search-cancel.png" /></form>
	<div id="friends">
		<div id="sort-friends">
			<span id="sort-name">name</span>
			<span id="sort-free">free/in class</span>
			<span id="sort-cic">courses in common</span>
		</div>
	  <ul id="friends-container"></ul>
	  <span class="nav-previous">previous page</span>
	  <span class="nav-next">next page</span>
  </div>
  <script type="text/javascript" src="/javascripts/slider.js"></script>
  <script type="text/javascript">
  $(document).ready(function() {
		
		if ($(this).val().length > 0) {
			$('#search-friends-cancel').show();
		} else {
			$('#search-friends-cancel').hide();
		}
		
		$('#sort-name').addClass('active');
   
		var activeSortIndex = 0;
		
		var sortedFriends = [];
    sortedFriends[0] = <%= @friends.order('users.name').map{|f| cic = f.courses_in_common(current_user); {'id'=>f.id, 'name'=>f.name, 'uid'=>f.uid, 'status'=>f.status, 'cic'=>cic, 'cic_count'=>cic.count}}.to_json.html_safe %>;

		sortedFriends[1] = sortedFriends[0].slice(0).sort(function(a, b) {
			var aStatus = a.status == 'free';
			var bStatus = b.status == 'free';
			if (aStatus == bStatus) {
				return a.name > b.name ? 1 : -1;
			} else {
				return aStatus < bStatus ? 1 : -1;
			}
		});
		
		sortedFriends[2] = sortedFriends[0].slice(0).sort(function(a, b) {
			var aCicCount = a.cic_count;
			var bCicCount = b.cic_count;
			if (aCicCount == bCicCount) {
				return a.name > b.name ? 1 : -1;
			} else {
				return aCicCount < bCicCount ? 1 : -1;
			}
		});

		var friendsHtml = $('#friends-container .friend');
		
		function makeActiveSortButton(sortButton) {
			$.each($('#sort-friends span'), function() {
				$(this).removeClass('active');
			});
			sortButton.addClass('active');
		}

    function refreshPages(friends) {
      html = '<li class="friends-page"><ul>';
      for(var i = 0; i < friends.length; ++i) {
				// start of a new friends page
        if(i && !(i % 10)) {
					html += '</ul></li><li class="friends-page"><ul>';
				}
				
				var f = friends[i];
        html += '<li class="friend"><a href="/friends/'+f.id+'"><img src="http://graph.facebook.com/'+f.uid+'/picture" /><span class="name">'+f.name+'</span><span class="status">'+f.status+'</span>';
      	html += '<span class="common-courses">';
				// tooltip if courses in common count is positive
				if (f.cic_count > 0) {
					html += '<span class="tooltip"><ul>';
					$.each(f.cic, function(index, course) {
						html += '<li>'+course.number+': '+course.name+'</li>';
					});
					html += '</ul></span>';
				}
				
				html += '<span class="count">'+f.cic_count+' courses in common</span></span>';   
			}
      html += '</a></li></ul></li>';
			// alert(html);
			// console.log('a');
      $('#friends-container').html(html);
			$('.common-courses .tooltip').hide();
			$('.common-courses .tooltip > ul > li').textOverflow();
      initSlider('#friends','#friends-container','.friends-page',0);
    }

		// default is to show friends sorted by name
    refreshPages(sortedFriends[activeSortIndex]);

    $('#search-friends').submit(function(e) {
      e.preventDefault();
    });

		function updateResults() {
			var input = $('#search-input').val().toLowerCase();
      var results = [];
      var regex = new RegExp(input,"gi");
      

      for(var i = 0; i < sortedFriends[activeSortIndex].length; ++i) {
        if(sortedFriends[activeSortIndex][i].name.search(regex) != -1) {
          results.push(sortedFriends[activeSortIndex][i]);
				}
      }

      refreshPages(results);
		}
		
    $('#search-input').keyup(function() {
			if ($(this).val().length > 0) {
				$('#search-friends-cancel').show();
			} else {
				$('#search-friends-cancel').hide();
			}
			updateResults();
    });

		$('#search-friends-cancel').click(function() {
			$('#search-input').val('');
			$('#search-friends-cancel').hide();
			updateResults();
		});

		$('#sort-name').click(function() {
			makeActiveSortButton($(this));
			activeSortIndex = 0;
			updateResults();
		});
		$('#sort-free').click(function() {
			makeActiveSortButton($(this));
			activeSortIndex = 1;
			updateResults();
		});
		$('#sort-cic').click(function() {
			makeActiveSortButton($(this));
			activeSortIndex = 2;
			updateResults();
		});
		
		
  });
  </script>
</div>
<% end %>
<%= render :partial => 'partials/mainpage' %>
