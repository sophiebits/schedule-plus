<% content_for :content do %>
<div class="main-aside">
  <!--
  <ul id="friends-sort-options">
    <li>Sort by Name</li>
    <li>Sort by Courses in Common</li>
  </ul>
  -->
  <span class="tooltip" id="share-prompt">
    Share schedule+ with your friends on facebook to see more schedules!
  </span>
  <a href="#" class="fb-share">Share</a>
  <script type="text/javascript">

	$(document).ready(function() {

    $('.fb-share').click(function(e) {
      e.preventDefault();
      FB.ui({ method:'feed',
        name:'schedule+',
        link:'http://scheduleplus.org/',
        picture:'http://scheduleplus.org/images/schedule-plus-logo-square.jpg',
        description:'schedule+ connects you to your Carnegie Mellon friends on Facebook by matching your planned course schedules. See which courses are most common among your friends, or find out which of your friends is free for a lunchtime get-together.',
        message:"I'm now using schedule+ to share my CMU schedule with friends. Check it out!"
      });
      return false;
    });

		$('.common-courses .tooltip').hide();
		$('.common-courses .tooltip > ul > li').textOverflow();
		
		$('#friends-container').delegate('.count','hover',function(e) {
      if (e.type === 'mouseenter')
        $(this).prev('.tooltip').show();
      else
		    $(this).prev('.tooltip').hide();
		});
	});
  </script>
</div>
<div id="article">
  <h1 class="friends">Friends</h1>
  <form id="search-friends"><input type="text" placeholder="Search Friends" id="search-input"></input></form>
  <div id="friends">
  <ul id="friends-container">
<% 
###########################################
@friends.order('users.name').each_with_index do |friend, index| 
%>
    <li class="friend">
      <a href="/friends/<%= friend.id %>">
        <img src="http://graph.facebook.com/<%= friend.uid %>/picture" />
        <span class="name"><%= friend.name %></span>
        <span class="status"><%= friend.status %></span>
        <span class="common-courses">
				  <%
					  courses_in_common = friend.courses_in_common(current_user)
					  if courses_in_common.length > 0
				  %>
      	  <span class="tooltip">
					  <ul>
						  <% courses_in_common.each do |course|	%>
						  <li><%= course.number + ': ' + course.name %></li>
					    <% end %>
					  </ul>
				  </span>
				<% end %>
				  <span class="count"><%= courses_in_common.length %> courses in common</span>
        </span>
      </a>
    </li>
<% 
end 
###########################################
%>
  </ul>
  <span class="nav-previous">previous page</span>
  <span class="nav-next">next page</span>
  </div>
  <script type="text/javascript" src="/javascripts/slider.js"></script>
  <script type="text/javascript">
  $(function() {
    
    var friends = <%= @friends.order('users.name').to_json.html_safe %>;
    var friendsHtml = $('#friends-container .friend');

    function refreshPages(friends) {
      if (!friends) {
        friends = [];
        for (var i = 0; i < friendsHtml.length; ++i)
          friends.push(i);
      }
      html = '<li class="friends-page"><ul>';
      for(var i=0;i<friends.length;++i) {
        if(i && !(i%10)) html += '</ul></li><li class="friends-page"><ul>';
        html += '<li class="friend">' + friendsHtml.eq(friends[i]).html() + '</li>';
      }
      html += '</ul></li>';
      $('#friends-container').html(html);
      initSlider('#friends','#friends-container','.friends-page',0);
    }

    refreshPages();

    $('#search-friends').submit(function(e) {
      e.preventDefault();
    });
    $('#search-input').keyup(function() {

      var input = $(this).val().toLowerCase();
      var results = [];
      var regex = new RegExp(input,"gi");
      
      for(var i = 0; i < friends.length; ++i) {
        if(friends[i].name.search(regex) != -1)
          results.push(i);
      }

      refreshPages(results);
    });
  });
  </script>
</div>
<% end %>
<%= render :partial => 'partials/mainpage' %>
